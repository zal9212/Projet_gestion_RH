<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enregistrer Absence - HR Solide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <nav>
        <a href="index.html" class="logo"><i class="fas fa-shield-alt"></i> HR • SOLIDE</a>
        <div class="nav-links">
            <a href="index.html">Accueil</a>
            <a href="mes-absences.html">Mes Absences</a>
            <a href="enregistrer-absence.html" class="active" data-role="ADMIN,MANAGER">Enregistrer</a>
            <a href="notifications.html">Notifications <span id="notification-badge" class="badge badge-error"
                    style="display:none;"></span></a>
            <a href="statistiques-absences.html" data-role="ADMIN,MANAGER">Statistiques</a>
        </div>
        <div id="user-info" style="font-weight: 600; color: var(--brand-primary);"></div>
    </nav>

    <div class="container" style="max-width: 800px;">
        <header class="page-header">
            <h1>Enregistrer une absence</h1>
            <p>Formulaire réservé aux managers pour consigner une nouvelle absence.</p>
        </header>

        <div class="card">
            <form id="absence-form">
                <div class="form-group">
                    <label for="employeId">Employé</label>
                    <input type="number" id="employeId" class="form-control" placeholder="ID de l'employé" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="dateDebut">Date de début</label>
                        <input type="date" id="dateDebut" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="dateFin">Date de fin</label>
                        <input type="date" id="dateFin" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="typeAbsenceId">Type d'absence</label>
                    <select id="typeAbsenceId" class="form-control" required>
                        <option value="">Chargement des types...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="commentaire">Commentaire (optionnel)</label>
                    <textarea id="commentaire" class="form-control" rows="3"
                        placeholder="Notes complémentaires..."></textarea>
                </div>

                <div style="display: flex; gap: 16px; margin-top: 20px;">
                    <button type="submit" class="btn btn-filled" style="flex: 1;"><i class="fas fa-save"></i>
                        Enregistrer l'absence</button>
                    <a href="index.html" class="btn btn-outline" style="flex: 1;">Annuler</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/absences.js"></script>
    <script src="../js/notifications.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = Utils.getCurrentUser();
            document.getElementById('user-info').textContent = user.name + " (" + user.role + ")";

            // Protection de la page
            if (!Utils.requireRole(['ADMIN', 'MANAGER'])) return;

            // Appliquer la sécurité sur le reste
            Utils.applyRoleSecurity();

            NotificationBadge.init();

            // Charger les types d'absences
            try {
                const types = await TypeAbsenceAPI.getAll();
                const select = document.getElementById('typeAbsenceId');
                select.innerHTML = '<option value="">Sélectionnez un type</option>' +
                    types.map(t => `<option value="${t.id}">${t.nom}</option>`).join('');
            } catch (e) {
                console.error(e);
            }

            // Gérer la soumission
            document.getElementById('absence-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const absenceData = {
                    employeId: parseInt(document.getElementById('employeId').value),
                    dateAbsence: document.getElementById('dateDebut').value, // On utilise dateDebut pour dateAbsence
                    typeAbsenceId: parseInt(document.getElementById('typeAbsenceId').value),
                    motif: document.getElementById('commentaire').value,
                    statut: 'VALIDE',
                    justifiee: false
                };

                try {
                    await AbsenceAPI.create(absenceData);
                    Utils.showSuccess("Absence enregistrée avec succès !");
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } catch (err) {
                    Utils.showError("Erreur : " + err.message);
                }
            });
        });
    </script>
</body>

</html>